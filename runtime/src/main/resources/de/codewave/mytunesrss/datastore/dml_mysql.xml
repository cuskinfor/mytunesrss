<?xml version="1.0" encoding="UTF-8"?>

<statements>

    <statement name="findRandomTracks">
        <sql>
            SELECT {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE (:sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM link_track_playlist ltp WHERE
            ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId))
            AND (:mediatype IS NULL OR t.mediatype = :mediatype)
            AND (NOT t.protected OR t.protected = :protected)
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY RAND() LIMIT :maxCount
        </sql>
    </statement>

    <statement name="findLastUpdatedTracks">
        <sql>
            SELECT {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE (:sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM link_track_playlist ltp WHERE
            ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId))
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY ts_updated DESC LIMIT :maxCount
        </sql>
    </statement>

    <statement name="findMostPlayedTracks">
        <sql>
            SELECT {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE (:sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM link_track_playlist ltp WHERE
            ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId))
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY playcount DESC LIMIT :maxCount
        </sql>
    </statement>

    <statement name="findAlbumImage">
        <sql>
            SELECT data AS data FROM image i, track t WHERE t.album = :album AND i.hash = t.image_hash AND i.size = :size LIMIT 1
        </sql>
    </statement>

    <statement name="nextPlaylistId">
        <sql>DELETE FROM playlist_id_sequence</sql>
        <sql>INSERT INTO playlist_id_sequence VALUES (0)</sql>
        <sql>SELECT LAST_INSERT_ID() AS id FROM playlist_id_sequence LIMIT 1</sql>
    </statement>

    <statement name="createSearchTempTables">
        <sql>
            CREATE TEMPORARY TABLE IF NOT EXISTS temp_lucene_tracks (
                track_id VARCHAR(100),
                UNIQUE(track_id)
            )
        </sql>
    </statement>

    <statement name="migrate_3.8.0_eap_1_part_3">
        <sql>ALTER TABLE track MODIFY COLUMN lower_artist VARCHAR(255) NOT NULL</sql>
    </statement>

    <!-- reusable sql fragments -->

    <fragment name="likeEscape">ESCAPE '\\'</fragment>

</statements>