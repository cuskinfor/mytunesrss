<?xml version="1.0" encoding="UTF-8"?>

<statements>

    <statement name="findRandomTracks">
        <sql>
            SELECT LIMIT 0 :maxCount RAND() AS rnd, {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            GROUP BY RAND(), {groupByTrackColumns}
            ORDER BY rnd
        </sql>
    </statement>

    <statement name="findLastUpdatedTracks">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            GROUP BY {groupByTrackColumns}
            ORDER BY ts_updated DESC
        </sql>
    </statement>

    <statement name="findMostPlayedTracks">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            GROUP BY {groupByTrackColumns}
            ORDER BY ts_playcount DESC
        </sql>
    </statement>

    <statement name="findTracksInRange">
        <sql>
            SELECT LIMIT :startIndex :selectCount t.id AS id, t.file AS file FROM track t ORDER BY id
        </sql>
    </statement>

    <statement name="findRandomTracksRestricted">
        <sql>
            SELECT LIMIT 0 :maxCount RAND() AS rnd, {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM link_track_playlist rltp, track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE (:sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId))
            AND rltp.playlist_id = :restrictedPlaylistId AND t.id = rltp.track_id
            GROUP BY RAND(), {groupByTrackColumns}
            ORDER BY rnd
        </sql>
    </statement>
    <statement name="findLastUpdatedTracksRestricted">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM link_track_playlist rltp, track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            AND rltp.playlist_id = :restrictedPlaylistId AND t.id = rltp.track_id
            GROUP BY {groupByTrackColumns}
            ORDER BY ts_updated DESC
        </sql>
    </statement>

    <statement name="findMostPlayedTracksRestricted">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}, COUNT(i.track_id) AS imagecount
            FROM link_track_playlist rltp, track t
            LEFT OUTER JOIN image i ON i.track_id = t.id
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            AND rltp.playlist_id = :restrictedPlaylistId AND t.id = rltp.track_id
            GROUP BY {groupByTrackColumns}
            ORDER BY ts_playcount DESC
        </sql>
    </statement>

    <statement name="findAlbumImage">
        <sql>
            SELECT LIMIT 0 1 data AS data
            FROM image i, track t
            WHERE t.album = :album
            AND i.track_id = t.id
            AND i.size = :size
        </sql>
    </statement>

    <statement name="nextPlaylistId">
        <sql>SELECT TOP 1 NEXT VALUE FOR playlist_id_sequence AS id FROM system_information</sql>
    </statement>

    <statement name="tuneDatabase">
        <sql>ANALYZE SAMPLE_SIZE 0</sql>
    </statement>

    <!-- reusable sql fragments -->

    <fragment name="likeEscape">ESCAPE '\'</fragment>

    <fragment name="updateArtistNameInAlbumTable">
        UPDATE album AS a SET a.artist = (SELECT LIMIT 0 1 t.artist FROM track AS t WHERE t.album = a.name) WHERE a.artist_count = 1
    </fragment>

</statements>