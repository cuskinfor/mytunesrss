<?xml version="1.0" encoding="UTF-8"?>

<statements>

    <!-- statement name="findAlbums">
        <parameter name="index" type="java.lang.Integer"/>
        <sql>
            <![CDATA[
            SELECT a.name AS albumname, a.track_count AS track_count, a.artist_count AS artist_count, a.artist AS artist, a.image_hash AS image_hash, a.year AS year
            FROM album a
            WHERE ((:artist IS NOT NULL AND a.name IN (SELECT DISTINCT(album) FROM track WHERE lower_artist = LOWER(:artist)))
            OR (:genre IS NOT NULL AND a.name IN (SELECT DISTINCT(album) FROM track WHERE lower_genre = LOWER(:genre))))
            AND (:filter IS NULL OR a.lower_name LIKE :filter)
            AND (a.year >= :min_year AND a.year <= :max_year)
            GROUP BY albumname, track_count, artist_count, artist, image_hash, year
            ORDER BY albumname
            ]]>
        </sql>
    </statement>

    <statement name="findAlbumsRestricted">
        <parameter name="index" type="java.lang.Integer"/>
        <sql>
            <![CDATA[
            SELECT a.name AS albumname, a.track_count AS track_count, a.artist_count AS artist_count, a.artist AS artist, a.image_hash AS image_hash, a.year AS year
            FROM album a, link_track_playlist rltp, track t
            WHERE ((:artist IS NOT NULL AND a.name IN (SELECT DISTINCT(album) FROM track WHERE lower_artist = LOWER(:artist)))
            OR (:genre IS NOT NULL AND a.name IN (SELECT DISTINCT(album) FROM track WHERE lower_genre = LOWER(:genre))))
            AND (:filter IS NULL OR a.lower_name LIKE :filter)
            AND (a.year >= :min_year AND a.year <= :max_year)
            AND rltp.playlist_id IN (:restrictedPlaylistIds[])
            AND rltp.track_id = t.id
            AND t.album = a.name
            GROUP BY albumname, track_count, artist_count, artist, image_hash, year
            ORDER BY albumname
            ]]>
        </sql>
    </statement -->

    <statement name="findRandomTracks">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE (:sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId))
            AND (:mediatype IS NULL OR t.mediatype = :mediatype)
            AND (NOT t.protected OR t.protected = :protected)
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY RAND()
        </sql>
    </statement>

    <statement name="findLastUpdatedTracks">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY ts_updated DESC
        </sql>
    </statement>

    <statement name="findMostPlayedTracks">
        <sql>
            SELECT LIMIT 0 :maxCount {trackColumns}
            FROM track t<restricted>, link_track_playlist rltp</restricted>
            WHERE :sourcePlaylistId IS NULL OR EXISTS (SELECT * FROM
                link_track_playlist ltp WHERE ltp.track_id = t.id AND ltp.playlist_id = :sourcePlaylistId)
            <restricted>
                AND rltp.playlist_id IN (:restrictedPlaylistIds[])
                AND t.id = rltp.track_id
            </restricted>
            ORDER BY playcount DESC
        </sql>
    </statement>

    <statement name="findAlbumImage">
        <sql>
            SELECT LIMIT 0 1 data AS data
            FROM image i, track t
            WHERE t.album = :album
            AND i.hash = t.image_hash
            AND i.size = :size
        </sql>
    </statement>

    <statement name="nextPlaylistId">
        <sql>SELECT TOP 1 NEXT VALUE FOR playlist_id_sequence AS id FROM system_information</sql>
    </statement>

    <statement name="createSearchTempTables">
        <sql>
            CREATE LOCAL TEMPORARY TABLE IF NOT EXISTS temp_lucene_tracks (
                track_id VARCHAR(100),
                UNIQUE(track_id)
            )
        </sql>
        <sql>
            CREATE LOCAL TEMPORARY TABLE IF NOT EXISTS temp_like_tracks (
                track_id VARCHAR(100),
                UNIQUE(track_id)
            )
        </sql>
    </statement>

    <!-- reusable sql fragments -->

    <fragment name="likeEscape">ESCAPE '\'</fragment>

</statements>