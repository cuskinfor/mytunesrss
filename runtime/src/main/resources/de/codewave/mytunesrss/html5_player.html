<html>

<head>

    <title>MyTunesRSS Jukebox</title>

    <meta name="viewport" content="width=device-width">

    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }

        #jukeboxdiv {
            position: absolute;
            top: 0;
            left: 0;
        }

        div.even {
            background-color: #ffffff;
        }

        div.odd {
            background-color: #f4f7fb;
        }

        div.current {
            color: #ff0000;
            font-weight: bold;
        }

        #playlist {
            margin-top: 30px;
        }

        div.playlistitem {
            padding-top: 10px;
            padding-bottom: 10px;
            padding-left: 5px;
            padding-right: 5px;
        }
    </style>

    <script type="text/javascript" src="../../js/jquery.js"></script>
    <script type="text/javascript">

        var playlist;
        var currentTrack;
        var currentJukebox;
        var currentPlayerPos;

        $(document).ready(function() {
            new $.ajax({
                url : "{PLAYLIST_URL}",
                type : "GET",
                processData : false,
                success : function(data) {
                    init(data);
                }
            });
        });

        function scrollPlayer() {
            $("#jukeboxdiv").css("top", ($(window).scrollTop() + 10) + "px");
            $(window)[0].setTimeout(scrollPlayer, 1000);
        }

        function clearJukeboxes() {
            $("#jukeboxdiv").empty();
        }

        function playTrack(index, stopCurrent) {
            // set marker in playlist
            $("#playlist div").each(function(eachIndex) {
                if (eachIndex == index) {
                    $(this).addClass("current");
                } else {
                    $(this).removeClass("current");
                }
            });

            // create new audio or video element and start playback
            if (index < playlist.length) {
                currentTrack = index;
                if (playlist[index].mediaType === "Video") {
                    clearJukeboxes();
                    $("#jukeboxdiv").append("<video controls=\"controls\" preload=\"none\" onended=\"clearJukeboxes()\" src=\"" + playlist[index].location + "\"></video>");
                    $("#jukeboxdiv video")[0].play();
                } else if (playlist[index].mediaType === "Audio" && $("#jukeboxdiv div").length === 0) {
                    clearJukeboxes();
                    $("#jukeboxdiv").append("<div><audio controls=\"controls\" preload=\"none\" ontimeupdate=\"updateTime()\" src=\"" + playlist[index].location + "\"></audio></div>");
                    $("#jukeboxdiv").append("<div style=\"display:none\"><audio controls=\"controls\" preload=\"none\" ontimeupdate=\"updateTime()\" src=\"http://127.0.0.1\"></audio></div>");
                    currentJukebox = "first";
                    $("#jukeboxdiv audio")[0].play();
                    $("#jukeboxdiv audio")[1].play();
                    $("#jukeboxdiv audio")[1].pause();
                } else {
                    var jukebox = $("#jukeboxdiv div:" + getOtherJukebox() + " audio");
                    jukebox.attr("src", playlist[index].location);
                    jukebox[0].play();
                    if (stopCurrent) {
                        $("#jukeboxdiv div:" + currentJukebox + " audio")[0].pause();
                    }
                    $("#jukeboxdiv div:" + currentJukebox).css("display", "none");
                    $("#jukeboxdiv div:" + currentJukebox).attr("src", "http://127.0.0.1");
                    currentJukebox = getOtherJukebox();
                    $("#jukeboxdiv div:" + currentJukebox).css("display", "block");
                }
            } else {
                clearJukeboxes();
            }

        }

        function getOtherJukebox() {
            return currentJukebox === "first" ? "last" : "first";
        }

        function updateTime() {
            var jukebox = $("#jukeboxdiv audio:" + currentJukebox)[0];
            if (jukebox.duration - jukebox.currentTime < 1) {
                var nextTrack = currentTrack + 1;
                while (nextTrack < playlist.length && playlist[nextTrack].mediaType === "Video") {
                    nextTrack++;
                }
                playTrack(nextTrack, false);
            }
        }

        function init(data) {
            playlist = data;
            for (var i = 0; i < data.length; i++) {
                $("#playlist").append("<div class=\"playlistitem " + (i % 2 == 0 ? "even" : "odd") + "\" onclick=\"playTrack(" + i + ", true)\">" + data[i].artist + " - " + data[i].name + "</div>");
            }
            scrollPlayer();
        }

    </script>

</head>

<body>

<div id="jukeboxdiv">
</div>

<div id="playlist">
</div>

</body>

</html>
