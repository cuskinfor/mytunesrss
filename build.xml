<?xml version="1.0" encoding="UTF-8"?>

<project name="mytunesrss" basedir="." default="zip.distribution">

    <property file="${user.home}/codewave-ant.properties"/>
    <property name="codewave.ant" value="${codewave.mytunesrss.ant}"/>

    <import file="${codewave.ant}/general.xml"/>
    <import file="${codewave.ant}/svn-macros.xml"/>
    <import file="${codewave.ant}/moduleinfo-macros.xml"/>
    <import file="${codewave.ant}/web-macros.xml"/>

    <path id="codewave.ant.taskdefs.classpath">
        <fileset dir="${codewave.ant}/lib"/>
    </path>

    <target name="generate.keypair" description="generate a key pair for registration">
        <taskdef name="keypair" classname="de.codewave.ant.task.registration.GenerateKeyPairTask">
            <classpath refid="codewave.ant.taskdefs.classpath"/>
        </taskdef>
        <keypair applicationname="MyTunesRSSv3" publickey="Runtime/src/MyTunesRSS.public" privatekey="etc/registration/MyTunesRSS.private"/>
    </target>

    <target name="create.registration" description="create a registration file">
        <taskdef name="signregistration" classname="de.codewave.ant.task.registration.CreateSignedRegistration">
            <classpath refid="codewave.ant.taskdefs.classpath"/>
        </taskdef>
        <signregistration privatekey="etc/registration/MyTunesRSS.private" registrationdata="etc/registration/MyTunesRSS.xml" signeddata="etc/registration/MyTunesRSS.key"/>
    </target>

    <target name="idea.after-compile" description="target to execute after compilation in idea">
        <antcall target="generate.moduleinfo"/>
        <antcall target="copy.tomcat-config"/>
        <copy todir="distribution/lib">
            <fileset dir="Runtime/lib">
                <include name="codewave-zis.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="generate.moduleinfo" description="generate the model information files">
        <svn.propget property="version" path="." name="codewave:version"/>
        <moduleinfo.jar destfile="distribution/MyTunesRSS.jar" name="MyTunesRSS" version="${version}"/>
    </target>

    <target name="copy.tomcat-config" description="copy the tomcat embedded configuration to the distribution">
        <copy todir="distribution" overwrite="true">
            <fileset dir="etc">
                <include name="conf/**"/>
            </fileset>
        </copy>
    </target>

    <target name="zip.distribution" description="generate a zip archive of the whole distribution">
        <svn.propget property="version" path="." name="codewave:version"/>
        <zip destfile="distribution/MyTunesRSS-${version}.zip">
            <zipfileset dir="distribution" prefix="MyTunesRSS-${version}">
                <include name="conf/**"/>
                <include name="lib/**"/>
                <include name="tomcat/**"/>
                <include name="webapps/**"/>
                <include name="MyTunesRSS.jar"/>
            </zipfileset>
            <zipfileset dir="etc/documentation" prefix="MyTunesRSS-${version}">
                <include name="**"/>
            </zipfileset>
        </zip>
        <zip destfile="distribution/MyTunesRSS_Windows-${version}.zip">
            <zipfileset dir="distribution" prefix="MyTunesRSS-${version}/data">
                <include name="conf/**"/>
                <include name="lib/**"/>
                <include name="tomcat/**"/>
                <include name="webapps/**"/>
                <include name="MyTunesRSS.jar"/>
            </zipfileset>
            <zipfileset dir="etc" prefix="MyTunesRSS-${version}/data">
                <include name="java.properties"/>
                <include name="*.dll"/>
            </zipfileset>
            <zipfileset dir="etc" prefix="MyTunesRSS-${version}">
                <include name="*.exe"/>
            </zipfileset>
            <zipfileset dir="etc/documentation" prefix="MyTunesRSS-${version}">
                <include name="**"/>
            </zipfileset>
        </zip>
        <zip destfile="distribution/MyTunesRSS_MacOSX-${version}.zip">
            <zipfileset dir="etc/MacOS-Bundle" prefix="MyTunesRSS-${version}">
                <exclude name="**/JavaApplicationStub*"/>
            </zipfileset>
            <zipfileset dir="etc/MacOS-Bundle" filemode="755" prefix="MyTunesRSS-${version}">
                <include name="**/JavaApplicationStub*"/>
            </zipfileset>
            <zipfileset dir="distribution" prefix="MyTunesRSS-${version}/MyTunesRSS.app/Contents/Resources/Java">
                <include name="conf/**"/>
                <include name="lib/**"/>
                <include name="tomcat/**"/>
                <include name="webapps/**"/>
                <include name="MyTunesRSS.jar"/>
            </zipfileset>
            <zipfileset dir="etc/documentation" prefix="MyTunesRSS-${version}">
                <include name="**"/>
            </zipfileset>
        </zip>
    </target>

    <target name="copy.distribution.website" description="copy the distribution to the website project">
        <copy todir="../Codewave/Website/download/files">
            <fileset dir="distribution">
                <include name="*.zip"/>
            </fileset>
        </copy>
    </target>

    <target name="compile.jsp" description="compile all JSPs">
        <jspc dir="distribution/webapps/ROOT">
            <cp>
                <fileset dir="distribution/lib" excludes="*log4j*.jar"/>
                <pathelement location="Runtime/classes"/>
            </cp>
        </jspc>
    </target>

</project>
